# Smart Support

Лёгкая и устойчивая система операторской поддержки с семантическим поиском шаблонов, проверкой орфографии, аналитикой качества и «мини‑SPA» фронтендом без тяжёлых фреймворков.

- Архитектура: FastAPI + SQLite + нативный JS
- Поиск и классификация: bge-m3 (эмбеддинги) + продуктовые бусты
- Доведение текста: Qwen2.5‑72B‑Instruct‑AWQ (строгий тон поддержки)
- Аналитика: агрегаты качества, голосование операторов, история
- UX: честные пороги уверенности, «не уверен — не подсказывай», тёмная тема

Система рассчитана на предсказуемость и управляемость качества: события логируются с контекстом, «слабые» подсказки отбрасываются, а статистика используется как мягкий вес для самоадаптации.

---

## Содержание

- [Архитектура](#архитектура)
- [Ключевые идеи](#ключевые-идеи)
- [Структура проекта](#структура-проекта)
- [Быстрый старт](#быстрый-старт)
- [Конфигурация](#конфигурация)
- [API (общее описание)](#api-общее-описание)
- [Данные и модели](#данные-и-модели)
- [Алгоритмы и пороги](#алгоритмы-и-пороги)
- [Фронтенд](#фронтенд)
- [Аналитика /analyst](#аналитика-analyst)
- [Эксплуатация и безопасность](#эксплуатация-и-безопасность)
- [Тестирование и отладка](#тестирование-и-отладка)
- [FAQ и устранение проблем](#faq-и-устранение-проблем)
- [Планы развития](#планы-развития)

---

## Архитектура

Единый контур «операторская панель → FastAPI → SQLite».

- Frontend: статические страницы (рабочее место и /analyst), единый бандл `app.js`, локальный минимальный стор и ручной дифф DOM.
- Backend: FastAPI (`backend/api.py`), доменная логика (`backend/services/logic.py`), доступ к данным и агрегаты (`backend/storage.py`), модели (`backend/models.py`).
- Хранилище: SQLite (`data/*.db`) для событий, истории, голосов и агрегатов.
- Интеграции: SciBox (эмбеддинги bge-m3, чат Qwen2.5‑72B‑Instruct‑AWQ).
- Инфраструктурные гарантии: «тёплый старт» (preload), rate limit на основе `deque`.

Потоки:
1) Оператор вводит запрос → поиск шаблонов → строгая фильтрация по порогу → выбор карточки → финализация → проверка орфографии → отправка ответа → логирование событий.
2) Классификация запроса → подсказка основной/подкатегории (при достаточной уверенности) → сбор голосов операторов → агрегация точности по категориям → витрины аналитики.
3) Автообновление аналитики и истории на фронтенде с интервалами.

---

## Ключевые идеи

- Единый порог релевантности (поиск: ~0.4, классификация: ~0.35 по raw score) — «не уверен → не подсказывай».
- Логирование контекста событий (`log_event`): в payload уходят `score_threshold`, `below_threshold`, `template_unmodified` и др. — аналитика без миграций схемы.
- Голоса операторов формируют «ground truth» (качество категорий/подкатегорий) — мягкая адаптация ранжирования.
- Мини‑SPA без фреймворка: локальный стор, `Map` для reconciliation ленты, без мерцаний.
- Аналитика как продукт: отдельный маршрут `/analyst`, агрегаты и обзоры «из коробки».
- Стабильность: warm‑up эмбеддингов и rate‑limit для обращений к LLM.

---

## Структура проекта

```
.
├── backend
│   ├── api.py                 # FastAPI-маршруты
│   ├── models.py              # Pydantic-модели (включая Analytics*)
│   ├── storage.py             # SQLite-операции, агрегаты, аналитика
│   ├── services
│   │   └── logic.py           # Бизнес-логика: поиск, классификация, финализация, орфография, логирование
│   ├── recommender.py / ...
│   └── scibox_client.py       # Клиент SciBox (chat/embed), LRU cache
├── frontend
│   ├── index_clean.html       # Рабочее место оператора
│   ├── app.js                 # Единый бандл логики, состояние, рендер, вызовы API
│   └── analyst
│       └── index.html         # Отдельная страница аналитики
├── data
│   └── *.db                   # База событий/истории/голосов
└── README.md
```

Примечание: точные имена некоторых файлов/модулей могут отличаться; см. исходники репозитория.

---

## Быстрый старт

Требования:
- Python 3.10+ (рекомендуется 3.11+)
- pip / venv
- Доступ к SciBox (API URL + API Key), если используете LLM/эмбеддинги
- Браузер (для статического фронтенда)

1) Клонирование и окружение
```bash
git clone https://github.com/Qward1/T1.git
cd T1
python -m venv .venv
source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

2) Настройка переменных окружения (см. раздел «Конфигурация»)
```bash
export SCIBOX_BASE_URL="https://api.scibox.example"
export SCIBOX_API_KEY="your_key_here"
# Необязательно: пороги, лимиты, порт и т.п.
```

3) Запуск бэкенда
```bash
uvicorn backend.api:app --host 0.0.0.0 --port 8000 --reload
```

4) Открытие фронтенда
- Вариант А: открыть файл `frontend/index_clean.html` напрямую в браузере.
- Вариант Б: отдать фронтенд как статику (любой простой сервер) и убедиться, что он обращается к вашему бэкенду (например, http://localhost:8000).
- Аналитика: `frontend/analyst/index.html` (использует общий `app.js` и API агрегатов).

Совет: для CORS может понадобиться включить соответствующие настройки в FastAPI, если фронт и бэк на разных происхождениях.

---

## Конфигурация

Переменные окружения (рекомендуемые):

- SCIBOX_BASE_URL — базовый URL SciBox
- SCIBOX_API_KEY — ключ доступа к SciBox
- DEFAULT_CHAT_MODEL — по умолчанию: Qwen2.5-72B-Instruct-AWQ
- DEFAULT_EMBEDDING_MODEL — по умолчанию: bge-m3
- SEARCH_SCORE_THRESHOLD — порог для подсказок поиска (по умолчанию ~0.4)
- SIMILARITY_THRESHOLD — порог для классификации (по умолчанию ~0.35 по raw score)
- TOP_K_RESULTS — число карточек, возвращаемых поиском (по умолчанию 3)
- RATE_LIMIT_WINDOW_SECONDS / RATE_LIMIT_MAX_CALLS — оконный лимит для обращений к LLM
- DATABASE_DIR — путь к каталогу `data` (по умолчанию ./data)
- APP_PORT — порт запуска (по умолчанию 8000)

Конфигурация читается через `Settings` / точки доступа в коде (см. `scibox_client.py`, `services/logic.py`).

---

## API (общее описание)

Точный список и сигнатуры маршрутов см. в `backend/api.py`. Ниже — ориентировочное описание основных возможностей, на основе реализованной логики:

- Поиск шаблонов: принимает текст запроса (+ контекст), возвращает до 3 релевантных карточек с `score`. Если top-1 ниже `SEARCH_SCORE_THRESHOLD`, возвращает пустой список и флаг ниже порога.
- Классификация: выдаёт предполагаемую категорию/подкатегорию и confidence. Если `raw_score < SIMILARITY_THRESHOLD`, классификация обнуляется.
- Финализация шаблона (LLM): принимает выбранный шаблон + извлечённые сущности, возвращает финализированный ответ в тоне оператора (temperature=0.0).
- Проверка орфографии (LLM): принимает текст, возвращает отредактированный, с данными об изменениях и латентности.
- Сбор фидбэка: учитывает `template_unmodified` — если оператор сильно переписал ответ, клиентский отзыв блокируется для чистоты метрик.
- Голосование классификации: операторы помечают верность основной/подкатегории; используется для построения «ground truth».
- Сводка/Аналитика: агрегаты количества, точности, обзоры операторов/клиентов, таблицы категорий/подкатегорий; история событий с голосами и флагами.

События логируются через `log_event` с полезной нагрузкой (`payload`) — это обеспечивает расширяемую аналитику без миграций.

---

## Данные и модели

Pydantic-модели (см. `backend/models.py`):

- AnalyticsOverviewEntry — обзорные карточки аналитики (операторы, клиенты, суммарные показатели)
- CategoryAccuracy — агрегаты точности по категориям
- SubcategoryAccuracy — агрегаты точности по подкатегориям
- AnalyticsSummary — блок аналитики как часть сводки
- StatsSummary — основная сводка, расширенная полем `analytics`

Таблицы (SQLite):
- chat_messages — хранит историю, включая флаги `template_unmodified`
- message_feedback — фидбэк клиентов/операторов; блокировка при изменённом шаблоне
- events — события с `kind` и `payload`
- дополнительные таблицы для голосов и агрегатов (см. `storage.py`)

Агрегаты:
- `fetch_summary` — общая сводка: количество, точности, история; формирует `analytics` для фронтенда
- `fetch_category_accuracy_stats` / `fetch_subcategory_accuracy_stats` — рейтинг по качеству; фильтрация пустых значений, аккуратная типизация float

---

## Алгоритмы и пороги

Семантический поиск:
- Нормализация запроса → bge-m3 эмбеддинг → умножение на матрицу FAQ → scores
- Продуктовый буст: +0.2 за совпадение в вопросе, +0.1 в ответе (если выделены упоминания продуктов)
- Отбор Top‑K (обычно 3), затем глобальный порог `SEARCH_SCORE_THRESHOLD` (~0.4) на top‑1: ниже порога — пустая выдача
- Все ключевые шаги оборачиваются `log_event` с контекстом (порог, сравнения, сущности)

Классификация:
- Единая модель (bge-m3) для кодирования запросов и шаблонов
- Два уровня оценки:
  - raw_score — истинная близость
  - adjusted_score — raw * weight (вес из статистики качества)
- Веса категорий/подкатегорий растут медленно (экспоненциальная форма), чтобы единичные кейсы не «ломали» поведение
- Порог `SIMILARITY_THRESHOLD` (~0.35) проверяется по raw_score; ниже — обнуление классификации и «Неизвестно» на фронте

Финализация и орфография (LLM):
- Qwen2.5‑72B‑Instruct‑AWQ с системными промптами для строгого операционного тона
- `finalize`: учитывает извлечённые сущности (product/currency/amount/geo/date), температура 0.0
- `spell_check`: аккуратные правки орфографии/пунктуации, фиксация латентности и флага изменений

Стабильность:
- Warm‑up (preload embeddings, cache) перед первыми запросами
- Rate limit (deque) по session/IP, чтобы исключить дудос/холодные старты

---

## Фронтенд

Единый бандл `frontend/app.js`:
- Состояние `state` (sessionId, чат, результаты, голоса, выбранная карточка)
- Рендер чата: `renderChatHistory` с `Map` для повторного использования DOM‑узлов (без «миганий»)
- Рендер результатов: не более 3 карточек, явное «Подходящего ответа нет», синхронизировано с бэкендом
- Выбор карточки → авто-вставка шаблона в textarea
- Кнопка «Проверить орфографию» — вызов LLM с блокировкой UI на период запроса
- Голосование по классификации: «Верно/Неверно» с дизейблом на время запроса
- Темизация: переменные CSS + переключатель темы, общая для / и /analyst
- Автообновление истории и аналитики по интервалам

Маршруты:
- Рабочее место: `frontend/index_clean.html`
- Аналитика: `frontend/analyst/index.html` (подключает общий `app.js`, переиспользует `renderAnalytics`)

---

## Аналитика (/analyst)

Страница `/analyst`:
- Отдельный маршрут со стилем, единый набор функций от `app.js`
- Карточки обзора: операторы, клиенты, суммарные показатели
- Таблицы по категориям/подкатегориям: точность, количество верных голосов
- История с полями `main_vote`, `sub_vote`, `template_positive` и др.
- Готовность к тёмной теме

Бэкенд:
- `fetch_summary` готовит все агрегаты и историю одним запросом — фронт не делает лишних вызовов

---

## Эксплуатация и безопасность

- Rate limiting по session/IP
- Warm‑up эмбеддингов при старте, чтобы исключить «холодные» задержки
- Логирование событий с контекстом (порог, ниже порога, флаги модификаций)
- Блокировка учёта клиентских отзывов, если оператор изменил шаблон — защита чистоты метрик
- CORS/HTTPS — включайте/настраивайте под ваше окружение
- Секреты (API ключи) — только через переменные окружения/секрет менеджер

---

## Тестирование и отладка

Рекомендации:
- Моки SciBox: временно отключайте внешние вызовы, используйте локальные фикстуры эмбеддингов и ответов LLM
- Проверка порогов: варьируйте `SEARCH_SCORE_THRESHOLD` / `SIMILARITY_THRESHOLD` и отслеживайте метрики «пустых ответов» и «неизвестной» классификации
- Журналы событий: используйте `log_event` для трассировки контекста и принятия решений
- Нагрузочные прогоны: проверьте стабильность rate limit и поведение warm‑up

---

## FAQ и устранение проблем

- «Всегда пустая выдача»:
  - Проверьте `SEARCH_SCORE_THRESHOLD` — возможно, завышен
  - Убедитесь, что эмбеддинги загружены, warm‑up отработал
  - Проверьте продуктовые бусты и наличие упоминаний продуктов
- «Классификация часто ‘Неизвестно’»:
  - Проверьте `SIMILARITY_THRESHOLD`
  - Проверьте полноту/качество шаблонов и их эмбеддинги
- «Орфография/финализация не работает»:
  - Проверьте SCIBOX_* конфигурацию и сетевую доступность
  - Проверьте rate limit и наличие ошибок в логах
- «Аналитика не обновляется»:
  - Проверьте автоинтервалы и вызовы `refreshStats()`
  - Убедитесь, что события/голоса действительно записываются (таблицы SQLite)

---

## Планы развития

- Экспорт аналитики (CSV/Parquet) и интеграции с BI
- Глубже настраиваемые бусты (по продуктам, сезонам, сегментам клиентов)
- Улучшенный редактор шаблонов и встроенные проверки соответствия политике
- Пороговые A/B‑эксперименты и автокалибровка
- Дополнительные источники «ground truth» (ревью лидов, контрольные выборки)

---


## Примечания по исходникам

В описании выше упоминаются конкретные участки кода (файлы/строки) для ориентира:
- backend/services/logic.py — обработчики событий и `log_event`; warm‑up; rate limit; контроль `template_unmodified`
- backend/storage.py — `fetch_summary`, `fetch_category_accuracy_stats`, `fetch_subcategory_accuracy_stats`, `record_classification_vote` и др.
- backend/models.py — расширенные модели для аналитики
- frontend/app.js — состояние, рендер, аналитика, голосование, spellcheck, мини‑SPA поведение
- frontend/analyst/index.html — страница аналитики с переиспользованием `app.js`

Пожалуйста, ориентируйтесь на актуальный код репозитория для точных сигнатур и названий маршрутов API.
