# Smart Support

Инструмент для операторов поддержки, который соединяет поиск по базе FAQ, автоматическую классификацию обращений и сбор обратной связи в едином веб‑интерфейсе. Проект включает FastAPI‑бэкенд, статический фронтенд и аналитику, построенную на данных SQLite.


## Основные возможности
- **Поиск по знаниям** — семантический подбор до трёх релевантных ответов с автоматическим фильтром по порогу качества.
- **Автоклассификация** — определение категории и подкатегории обращения с возможностью оператора подтвердить или опровергнуть результат.
- **Готовые шаблоны** — перенос текста найденного ответа в форму, орфографическая проверка и отправка в чат.
- **Обратная связь** — фиксация голосов по классификациям и шаблонам, учёт отзывов клиентов, хранение истории действий.
- **Аналитика** — отдельная витрина `/analyst` с ключевыми метриками, точностью по категориям и обзором качества работы команды.


## Архитектура
```
frontend/            — одностраничный интерфейс операторов и страница аналитики
backend/             — FastAPI‑приложение, обработчики, модели, доступ к данным
data/                — SQLite‑файлы (история событий, чат, метрики)
tests/               — интеграционные проверки API
dev.py, Makefile     — утилиты для локального запуска
```
Все запросы фронтенда идут в REST‑эндпоинты `/api/...`, а статистика строится по логам, которые backend записывает через `log_event`.


## Требования
- Python 3.10+
- `pip` и `virtualenv`
- Доступ к API Scibox (нужен ключ `SCIBOX_API_KEY`)

Дополнительно: Docker (для контейнерного запуска).


## Быстрый старт (локально)
1. Клонировать репозиторий и создать виртуальное окружение:
   ```bash
   python -m venv .venv
   .venv\Scripts\activate        # Windows
   source .venv/bin/activate     # Linux / macOS

   pip install -r requirements.txt
   ```

2. Скопировать `.env.example` → `.env` и заполнить значения:
   ```env
   SCIBOX_API_KEY=your_api_key
   SCIBOX_BASE_URL=https://api.scibox.ai/v1
   # FAQ_PATH=/absolute/path/to/faq.xlsx   # опционально: Excel с базой ответов
   # ADMIN_TOKEN=change_me                  # для защищённых маршрутов, если используется
   ```

3. Запустить dev‑сервисы (API + статический фронтенд):
   ```bash
   python dev.py
   ```
   По умолчанию поднимутся:
   - API: http://127.0.0.1:8000  
   - Операторская панель: http://127.0.0.1:3000/index_clean.html  
   - Альтернативный статический сервер: http://127.0.0.1:3001/

   Отдельная страница аналитики доступна по адресу http://127.0.0.1:3000/analyst/.



## Работа с индексом FAQ
- Убедитесь, что Excel с ответами указан в `.env` (`FAQ_PATH`).
- Построение / обновление индекса:
  ```bash
  python -m backend.build_index
  ```
- Во время работы сервиса индекс можно перестроить через `POST /api/index/rebuild` (потребуется заголовок `X-Admin-Token`, если включена защита).


## Команды для проверки
```bash
make fmt    # black + ruff
make test   # pytest + httpx
```


## Полезные HTTP‑эндпоинты
- `POST /api/search` — поиск ответов по базе знаний.
- `POST /api/classify` — автоопределение категории/подкатегории и уверенности модели.
- `POST /api/feedback` — фидбэк по выбранному шаблону.
- `POST /api/quality/classification` — голос оператора за корректность классификации.
- `POST /api/quality/template` — голос за корректность шаблона.
- `GET /api/stats/summary` — агрегированная аналитика (используется на `/analyst`).
- `POST /api/index/rebuild` — пересборка индекса FAQ (для админов).

Подробные схемы находятся в `backend/models.py`.


## Docker
1. Скопируйте `.env.example` → `.env` и заполните переменные.
2. Соберите и запустите контейнеры:
   ```bash
   docker compose up --build
   ```
3. После запуска:
   - API: http://localhost:8000
   - Операторская панель: http://localhost:3000
   - Дополнительный статичный сервер: http://localhost:3001

Остановка и очистка: `docker compose down`. Важно: SQLite‑файлы лежат в `data/`, том прикреплён к рабочему каталогу, поэтому данные сохраняются между рестартами.


## Что почитать в коде
- `backend/services/logic.py` — основной поток работы (поиск, классификация, логирование, обработка фидбэка).
- `frontend/app.js` — состояние фронта и «мини‑реактив» для обновления DOM без фреймворков.
- `frontend/analyst/index.html` — отдельная витрина аналитики, использующая общий `app.js` для загрузки данных.
- `codreview.txt` — подробный обзор технических решений и идей, выделенных в проекте.



